<!DOCTYPE html>
<html lang="en">
<head>
  <title>Expense Eye ‚Äì Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* THEME TOKENS */
      --bg: #0e1418;
      --bg-mesh: radial-gradient(ellipse 90% 70% at 15% 10%, rgba(28, 74, 89, 0.6) 0%, transparent 60%),
                 radial-gradient(ellipse 70% 60% at 85% 5%, rgba(63, 39, 92, 0.5) 0%, transparent 65%),
                 linear-gradient(160deg, #0c1317 0%, #0f1c22 40%, #0e161c 100%);
      
      --glass: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.1);

      --text: #e6f0f3;
      --muted: #9fb6bf;
      
      --accent: #7c5cff;
      --expense: #f87171; 
      --refund: #34d399; 
      --cashback: #a78bfa;
      
      --font: 'Plus Jakarta Sans', sans-serif;
      --mono: 'DM Mono', monospace;
      --radius: 20px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font); background: var(--bg); color: var(--text);
      background-image: var(--bg-mesh); background-attachment: fixed;
      min-height: 100vh;
    }
    
    /* Noise Texture */
    body::before {
      content: ''; position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
      opacity: 0.4; pointer-events: none; z-index: 0;
    }

    /* TOPBAR */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 36px; height: 70px;
      background: rgba(14, 20, 24, 0.85); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
    }
    .logo { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px; cursor:pointer; }
    
    /* TABS (The Switcher) */
    .nav-tabs { display: flex; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; }
    .tab-btn {
      padding: 8px 20px; border-radius: 8px; border: none; background: transparent;
      color: var(--muted); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px;
    }
    .tab-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 10px rgba(124,92,255,0.3); }
    
    .action-btn {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: var(--text); padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;
    }
    .action-btn:hover { background: rgba(255,255,255,0.1); }

    /* LAYOUT */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; position: relative; z-index: 1; }
    
    .view-section { display: none; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }
    
    /* CARDS */
    .grid-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 30px; }
    .stat-card {
      background: rgba(255,255,255,0.03); backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 24px;
    }
    .stat-label { font-size: 11px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; letter-spacing: 1px; }
    .stat-value { font-family: var(--mono); font-size: 26px; font-weight: 500; }
    
    .val-expense { color: var(--expense); }
    .val-refund { color: var(--refund); }
    .val-cashback { color: var(--cashback); }

    /* PANELS */
    .panel {
      background: rgba(255,255,255,0.02); backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 24px; margin-bottom: 24px;
    }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .panel-title { font-weight: 700; font-size: 16px; }

    /* TABLES */
    .tx-table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
    .tx-row { background: rgba(255,255,255,0.02); }
    .tx-row td { padding: 14px; font-size: 14px; }
    .tx-row td:first-child { border-radius: 12px 0 0 12px; }
    .tx-row td:last-child { border-radius: 0 12px 12px 0; }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .badge-expense { background: rgba(248,113,113,0.15); color: var(--expense); }
    .badge-refund { background: rgba(52,211,153,0.15); color: var(--refund); }

    /* MODALS */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal { background: #151b22; width: 400px; padding: 30px; border-radius: 24px; border: 1px solid var(--glass-border); }
    .form-group { margin-bottom: 16px; }
    .form-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 12px; border-radius: 10px; outline: none; }

    /* TOAST (POPUP) */
    #toast {
      visibility: hidden; min-width: 250px; background-color: #34d399; color: #0e1418; text-align: center;
      border-radius: 8px; padding: 12px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
      transform: translateX(-50%); font-weight: 600; font-size: 14px;
      box-shadow: 0 4px 12px rgba(52,211,153,0.4);
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
  </style>
</head>
<body>

<div class="topbar">
  <div class="logo" onclick="location.href='/'">
    <span>üëÅÔ∏è</span> Expense Eye
  </div>
  
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchView('spending', this)">Spending</button>
    <button class="tab-btn" onclick="switchView('subscriptions', this)">Subscriptions</button>
  </div>

  <div style="display:flex; gap:10px;">
    <button class="action-btn" onclick="location.href='/'">Home</button>
    <button class="action-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">

  <div id="view-spending" class="view-section active">
    <div class="grid-stats">
      <div class="stat-card">
        <div class="stat-label">Total Expense</div>
        <div class="stat-value val-expense" id="statExpense">‚Çπ--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Refund</div>
        <div class="stat-value val-refund" id="statRefund">‚Çπ--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Cashback</div>
        <div class="stat-value val-cashback" id="statCashback">‚Çπ--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Transactions</div>
        <div class="stat-value" id="statCount">--</div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 350px 1fr; gap:24px;">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Merchant Split</span>
        </div>
        <canvas id="chartPie" height="250"></canvas>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Recent Transactions</span>
          <button class="action-btn" style="background:var(--accent); border:none; color:white;" onclick="openModal('txModal')">+ Manual Entry</button>
        </div>
        <table class="tx-table">
          <thead>
            <tr style="text-align:left; color:var(--muted); font-size:11px; text-transform:uppercase;">
              <th style="padding:0 0 10px 14px;">Merchant</th>
              <th style="padding:0 0 10px 14px;">Type</th>
              <th style="padding:0 0 10px 14px; text-align:right;">Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="view-subscriptions" class="view-section">
    <div class="grid-stats" style="grid-template-columns: 1fr 1fr;">
      <div class="stat-card">
        <div class="stat-label">Monthly Recurring Cost</div>
        <div class="stat-value" style="color:#fbbf24" id="subTotal">‚Çπ0.00</div>
        <div style="font-size:12px; color:var(--muted); margin-top:5px;">Calculated average per month</div>
      </div>
      <div class="stat-card" style="display:flex; align-items:center; justify-content:center; cursor:pointer; border-style:dashed; border-color:var(--glass-border);" onclick="openModal('subModal')">
        <div style="font-weight:600; color:var(--accent);">+ Add New Subscription</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Active Subscriptions</span>
        <button class="action-btn" onclick="openModal('subModal')">+ Add New</button>
      </div>
      <table class="tx-table">
        <thead>
          <tr style="text-align:left; color:var(--muted); font-size:11px; text-transform:uppercase;">
            <th style="padding:14px;">Service</th>
            <th style="padding:14px;">Cycle</th>
            <th style="padding:14px;">Next Bill</th>
            <th style="padding:14px; text-align:right;">Amount</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="subListTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="txModal">
  <div class="modal">
    <h3>Add Transaction</h3>
    <br>
    <div class="form-group"><input id="m_merch" class="form-input" placeholder="Merchant Name"></div>
    <div class="form-group"><input id="m_amt" type="number" class="form-input" placeholder="Amount (‚Çπ)"></div>
    <div class="form-group">
      <select id="m_type" class="form-input" style="background:#1a2026">
        <option value="expense">Expense</option>
        <option value="refund">Refund</option>
        <option value="cashback">Cashback</option>
      </select>
    </div>
    <div class="form-group"><input id="m_date" type="date" class="form-input"></div>
    <button class="action-btn" style="width:100%; background:var(--accent); color:white; border:none;" onclick="saveTx()">Save Transaction</button>
    <button class="action-btn" style="width:100%; margin-top:10px;" onclick="closeModal('txModal')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="subModal">
  <div class="modal">
    <h3>Add Subscription</h3>
    <br>
    <div class="form-group"><label style="font-size:12px; color:var(--muted);">Service Name</label><input id="s_name" class="form-input" placeholder="e.g. Netflix"></div>
    <div class="form-group"><label style="font-size:12px; color:var(--muted);">Amount (‚Çπ)</label><input id="s_amt" type="number" class="form-input" placeholder="499"></div>
    <div class="form-group"><label style="font-size:12px; color:var(--muted);">Billing Cycle</label>
      <select id="s_cycle" class="form-input" style="background:#1a2026">
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <div class="form-group"><label style="font-size:12px; color:var(--muted);">Next Billing Date</label><input id="s_date" type="date" class="form-input"></div>
    <button class="action-btn" style="width:100%; background:var(--accent); color:white; border:none;" onclick="saveSub()">Save Subscription</button>
    <button class="action-btn" style="width:100%; margin-top:10px;" onclick="closeModal('subModal')">Cancel</button>
  </div>
</div>

<div id="toast">Operation Successful</div>

<script>
  const fmt = n => parseFloat(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const get = id => document.getElementById(id);
  get('m_date').valueAsDate = new Date();
  get('s_date').valueAsDate = new Date();

  function switchView(viewName, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + viewName).classList.add('active');
  }

  function showToast(msg) {
    const t = get('toast');
    t.innerText = msg;
    t.className = "show";
    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
  }

  async function loadAll() {
    await Promise.all([loadSummary(), loadTx(), loadChart(), loadSubs()]);
  }

  async function loadSummary() {
    const res = await fetch('/api/transactions/summary');
    const d = await res.json();
    get('statExpense').innerText = '‚Çπ' + fmt(d.total_expense);
    get('statRefund').innerText = '‚Çπ' + fmt(d.total_refund);
    get('statCashback').innerText = '‚Çπ' + fmt(d.total_cashback);
    get('statCount').innerText = d.expense_count + d.refund_count;
  }

  async function loadTx() {
    const res = await fetch('/api/transactions');
    const data = await res.json();
    const html = data.map(t => `
      <tr class="tx-row">
        <td><div style="font-weight:600; color:#fff;">${t.merchant_name}</div><div style="font-size:11px; color:var(--muted);">${new Date(t.transaction_date).toLocaleDateString()}</div></td>
        <td><span class="badge badge-${t.type}">${t.type}</span></td>
        <td style="font-family:var(--mono); text-align:right;">${t.type==='expense'?'-':'+'}‚Çπ${fmt(t.amount)}</td>
        <td style="text-align:right;"><button onclick="deleteTx(${t.id})" style="background:none; border:none; color:#555; cursor:pointer;">√ó</button></td>
      </tr>
    `).join('');
    get('txList').innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding:20px;">No transactions</td></tr>';
  }

  async function loadChart() {
    const res = await fetch('/api/transactions/merchant-summary');
    const data = await res.json();
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(get('chartPie'), {
      type: 'doughnut',
      data: {
        labels: data.map(d => d.merchant_name),
        datasets: [{
          data: data.map(d => d.total_expense),
          backgroundColor: ['#7c5cff', '#f87171', '#34d399', '#fbbf24', '#60a5fa'], borderWidth: 0
        }]
      },
      options: { cutout: '75%', plugins: { legend: { position:'right', labels:{ color:'#9fb6bf', font:{size:11} } } } }
    });
  }

  // --- SUBSCRIPTIONS ---
  async function loadSubs() {
    const res = await fetch('/api/subscriptions');
    const d = await res.json();
    
    get('subTotal').innerText = '‚Çπ' + fmt(d.total_monthly);
    
    const html = d.subscriptions.map(s => `
      <tr class="tx-row">
        <td style="font-weight:600; color:white;">${s.service_name}</td>
        <td><span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:11px;">${s.billing_cycle}</span></td>
        <td style="color:var(--muted); font-size:13px;">${new Date(s.next_billing_date).toLocaleDateString()}</td>
        <td style="font-family:var(--mono); text-align:right;">‚Çπ${fmt(s.amount)}</td>
        <td style="text-align:right;"><button onclick="deleteSub(${s.id})" style="background:none; border:none; color:#555; cursor:pointer;">√ó</button></td>
      </tr>
    `).join('');
    
    get('subListTable').innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted);">No active subscriptions found. Add one!</td></tr>';
  }

async function saveSub() {
    const payload = {
      service_name: get('s_name').value,
      amount: get('s_amt').value,
      cycle: get('s_cycle').value,
      next_date: get('s_date').value
    };
    
    if(!payload.service_name || !payload.amount) return alert('Please fill in Service Name and Amount');

    try {
      const res = await fetch('/api/subscriptions', {
        method: 'POST', 
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      // STOP HERE if the server returned an error (like 500 or 400)
      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.message || 'Server failed to save');
      }
      
      // Only runs if successful
      closeModal('subModal');
      showToast('Subscription Added Successfully! ‚úì');
      loadSubs(); // Refresh the list
      
      // Clear inputs
      get('s_name').value = '';
      get('s_amt').value = '';
    } catch (err) {
      alert('Error: ' + err.message); // Show the actual error to the user
      console.error(err);
    }
  }
  
  async function deleteSub(id) {
    if(!confirm('Stop tracking this subscription?')) return;
    await fetch('/api/subscriptions/'+id, { method: 'DELETE' });
    loadSubs();
    showToast('Subscription Deleted');
  }

  async function saveTx() {
    await fetch('/api/transactions', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ 
        merchant_name: get('m_merch').value, 
        amount: get('m_amt').value, 
        type: get('m_type').value, 
        date: get('m_date').value 
      })
    });
    closeModal('txModal');
    showToast('Transaction Added! ‚úì');
    loadAll();
  }

  async function deleteTx(id) {
    if(!confirm('Delete?')) return;
    await fetch('/api/transactions/'+id, { method: 'DELETE' });
    loadAll();
    showToast('Transaction Deleted');
  }

  function openModal(id) { get(id).classList.add('active'); }
  function closeModal(id) { get(id).classList.remove('active'); }
  async function logout() { await fetch('/api/logout', { method:'POST' }); location.href='/'; }

  // START
  loadAll();
</script>
</body>
</html>